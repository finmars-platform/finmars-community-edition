{% extends "base.html" %}
{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/" style="color: #007BFF; text-decoration: none; font-weight: 500;">â† Back to Setup</a>
</div>

<h2>Backup & Restore</h2>
<p class="intro">Create, restore, and manage backups of your Finmars Community Edition installation. Backups include configuration files, databases, and application data.</p>

<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #28a745;">
    <h3 style="margin-top: 0; color: #28a745;">ğŸ’¾ Create New Backup</h3>
    <form id="createBackupForm" style="display: flex; gap: 10px; align-items: end;">
        <button type="submit" class="btn" style="background-color: #28a745; margin: 0; white-space: nowrap;">ğŸ“¦ Create Backup</button>
    </form>
</div>

<div id="message" style="display: none; padding: 10px; margin: 10px 0; border-radius: 4px;"></div>

<div class="backups-container">
    <h3 style="margin-bottom: 20px;">ğŸ“‹ Available Backups</h3>
    
    {% if backups %}
        <div class="backups-list">
            {% for backup in backups %}
            <div class="backup-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; background: #fafafa;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0; color: #333;">{{ backup.date }}</h4>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="downloadBackup('{{ backup.timestamp }}')" class="btn" style="background-color: #007BFF; padding: 6px 12px; font-size: 0.9rem;">ğŸ“¥ Download</button>
                        <button onclick="restoreBackup('{{ backup.date }}', '{{ backup.timestamp }}')" class="btn" style="background-color: #ffc107; color: #212529; padding: 6px 12px; font-size: 0.9rem;">ğŸ”„ Restore</button>
                        <button onclick="deleteBackup('{{ backup.date }}', '{{ backup.timestamp }}')" class="btn" style="background-color: #dc3545; padding: 6px 12px; font-size: 0.9rem;">ğŸ—‘ï¸ Delete</button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem; color: #666;">
                    <div>
                        <strong>Created:</strong><br>
                        {{ backup.created }}
                    </div>
                    <div>
                        <strong>Size:</strong><br>
                        {{ "%.1f"|format(backup.size / 1024 / 1024) }} MB
                    </div>

                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border-radius: 8px;">
            <h4 style="margin-top: 0;">No backups found</h4>
            <p>Create your first backup to get started with protecting your Finmars installation.</p>
        </div>
    {% endif %}
</div>

<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 30px; border-left: 4px solid #17a2b8;">
    <h3 style="margin-top: 0; color: #17a2b8;">ğŸ”„ Restore from Backup File</h3>
    <p style="margin: 10px 0; font-size: 0.9rem; color: #666;">
        Upload a backup file (dump.zip from another Finmars instance) to restore it on this server.
    </p>
    <form id="restoreFromFileForm" enctype="multipart/form-data" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
        <input type="file" id="restoreBackupFile" name="backup_file" accept=".zip" style="flex: 1 1 auto; max-width: 320px;">
        <button type="submit" class="btn" id="restoreFromFileButton" style="background-color: #17a2b8; margin: 0; white-space: nowrap;" disabled>
            ğŸ”„ Restore from File
        </button>
    </form>
    <p style="margin-top: 10px; font-size: 0.85rem; color: #856404;">
        Restoring from a file will completely overwrite the current data with the contents of the uploaded backup. A safety backup of the current state will be created automatically.
    </p>
</div>

<div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007BFF;">
    <h4 style="margin-top: 0; color: #007BFF;">â„¹ï¸ Backup Information</h4>
    <ul style="margin: 10px 0; padding-left: 20px;">
        <li><strong>What's included:</strong> Configuration files (.env, docker-compose.yml), databases, Keycloak data, Nginx configs, and application data</li>
        <li><strong>What's NOT included:</strong> Docker images, logs, and temporary files</li>
        <li><strong>Storage:</strong> Backups are stored in the <code>/backups</code> directory</li>
        <li><strong>Restore process:</strong> Click the "Restore" button to restore a backup. Containers will be stopped during restore and restarted automatically</li>
        <li><strong>Safety:</strong> Always test backups in a non-production environment first</li>
        <li><strong>Data Loss Warning:</strong> Restoring a backup will permanently replace all current data with the backup data</li>
    </ul>
</div>

<style>
    .backup-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.2s;
    }
    
    .btn:disabled {
        background-color: #6c757d !important;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .success-message {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .error-message {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .info-message {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .warning-message {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    input[type="file"] {
        padding: 8px;
        border: 2px dashed #17a2b8;
        border-radius: 4px;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: border-color 0.3s ease;
    }

    input[type="file"]:hover {
        border-color: #138496;
    }

    input[type="file"]:focus {
        outline: none;
        border-color: #138496;
        box-shadow: 0 0 0 2px rgba(23, 162, 184, 0.25);
    }
</style>

<script>
    let messageTimeout;

    function showMessage(message, type = 'info', durationMs = 5000) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = message;
        messageDiv.className = type + '-message';
        messageDiv.style.display = 'block';

        if (messageTimeout) {
            clearTimeout(messageTimeout);
        }
        
        messageTimeout = setTimeout(() => {
            messageDiv.style.display = 'none';
        }, durationMs);
    }
    
    document.getElementById('createBackupForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        this.querySelector('button').disabled = true;
        document.body.classList.add('loading');
        showMessage('Creating backup... This may take several minutes.', 'info');
        
        try {
            const response = await fetch('/backup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                showMessage(result.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showMessage(result.message, 'error');
            }
        } catch (error) {
            showMessage('Error creating backup: ' + error.message, 'error');
        } finally {
            this.querySelector('button').disabled = false;
            document.body.classList.remove('loading');
        }
    });

    const restoreFileInput = document.getElementById('restoreBackupFile');
    const restoreFileButton = document.getElementById('restoreFromFileButton');

    if (restoreFileInput && restoreFileButton) {
        restoreFileInput.addEventListener('change', function () {
            restoreFileButton.disabled = !(restoreFileInput.files && restoreFileInput.files.length > 0);
        });

        document.getElementById('restoreFromFileForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!restoreFileInput.files || restoreFileInput.files.length === 0) {
                showMessage('Please select a backup file to upload.', 'warning');
                return;
            }

            const warningMessage = `âš ï¸ WARNING: Restoring from an uploaded backup file will:\n\n` +
                                  `â€¢ Stop all running containers\n` +
                                  `â€¢ Replace current database and application data with the uploaded backup\n` +
                                  `â€¢ Restart all containers\n\n` +
                                  `This action will PERMANENTLY LOSE all current data!\n\n` +
                                  `Are you absolutely sure you want to proceed?`;

            if (!confirm(warningMessage)) {
                return;
            }

            if (!confirm('FINAL WARNING: This will permanently replace all current data with the uploaded backup file. Do you want to continue?')) {
                return;
            }

            const formData = new FormData();
            formData.append('backup_file', restoreFileInput.files[0]);

            restoreFileButton.disabled = true;
            restoreFileInput.disabled = true;
            document.body.classList.add('loading');

            showMessage('Uploading backup and starting restore process... This may take several minutes.', 'info', 180000);

            try {
                const response = await fetch('/backup', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(result.message, 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    showMessage(result.message || 'Restore from uploaded file failed.', 'error');
                }
            } catch (error) {
                showMessage('Error restoring from uploaded backup: ' + error.message, 'error');
            } finally {
                restoreFileButton.disabled = false;
                restoreFileInput.disabled = false;
                document.body.classList.remove('loading');
            }
        });
    }

    function downloadBackup(timestamp) {
        // Create a temporary link element to trigger download
        const link = document.createElement('a');
        link.href = `/backup/${timestamp}/download`;
        link.download = `backup_${timestamp}.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showMessage('Download started...', 'info');
    }

    async function restoreBackup(date, timestamp) {
        const warningMessage = `âš ï¸ WARNING: Restoring backup from "${date}" will:\n\n` +
                              `â€¢ Stop all running containers\n` +
                              `â€¢ Replace current database data with backup data\n` +
                              `â€¢ Restart all containers\n\n` +
                              `This action will PERMANENTLY LOSE all current data!\n\n` +
                              `Are you absolutely sure you want to proceed?`;
        
        if (!confirm(warningMessage)) {
            return;
        }

        // Final confirmation for safety
        if (!confirm(`FINAL WARNING: This will permanently replace all current data with backup from "${date}".\n\nDo you want to continue?`)) {
            return;
        }
        
        document.body.classList.add('loading');
        showMessage('Starting restore process... This may take several minutes.', 'info', 180000);
        
        try {
            const response = await fetch(`/backup/${timestamp}/restore`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showMessage(result.message, 'success');
                // Refresh the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                showMessage(result.message, 'error');
            }
        } catch (error) {
            showMessage('Error restoring backup: ' + error.message, 'error');
        } finally {
            document.body.classList.remove('loading');
        }
    }

    async function deleteBackup(date, timestamp) {
        if (!confirm(`Are you sure you want to delete backup from "${date}"? This action cannot be undone.`)) {
            return;
        }
        
        showMessage('Deleting backup...', 'info');
        
        try {
            const response = await fetch('/backup', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ timestamp: timestamp })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showMessage(result.message, 'success');
                // Refresh the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showMessage(result.message, 'error');
            }
        } catch (error) {
            showMessage('Error deleting backup: ' + error.message, 'error');
        }
    }
</script>
{% endblock %}
