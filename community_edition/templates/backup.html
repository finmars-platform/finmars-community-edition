{% extends "base.html" %}
{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/" style="color: #007BFF; text-decoration: none; font-weight: 500;">‚Üê Back to Setup</a>
    <span style="margin: 0 10px;">|</span>
    <a href="/versions" style="color: #007BFF; text-decoration: none; font-weight: 500;">Version Management</a>
</div>

<h2>Backup & Restore</h2>
<p class="intro">Create, restore, and manage backups of your Finmars Community Edition installation. Backups include configuration files, databases, and application data.</p>

<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #28a745;">
    <h3 style="margin-top: 0; color: #28a745;">üíæ Create New Backup</h3>
    <form id="createBackupForm" style="display: flex; gap: 10px; align-items: end;">
        <button type="submit" class="btn" style="background-color: #28a745; margin: 0; white-space: nowrap;">üì¶ Create Backup</button>
    </form>
</div>

<div id="message" style="display: none; padding: 10px; margin: 10px 0; border-radius: 4px;"></div>

<div class="backups-container">
    <h3 style="margin-bottom: 20px;">üìã Available Backups</h3>
    
    {% if backups %}
        <div class="backups-list">
            {% for backup in backups %}
            <div class="backup-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; background: #fafafa;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0; color: #333;">{{ backup.date }}</h4>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="downloadBackup('{{ backup.timestamp }}')" class="btn" style="background-color: #007BFF; padding: 6px 12px; font-size: 0.9rem;">üì• Download</button>
                        <button onclick="restoreBackup('{{ backup.date }}', '{{ backup.timestamp }}')" class="btn" style="background-color: #ffc107; color: #212529; padding: 6px 12px; font-size: 0.9rem;">üîÑ Restore</button>
                        <button onclick="deleteBackup('{{ backup.date }}', '{{ backup.timestamp }}')" class="btn" style="background-color: #dc3545; padding: 6px 12px; font-size: 0.9rem;">üóëÔ∏è Delete</button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem; color: #666;">
                    <div>
                        <strong>Created:</strong><br>
                        {{ backup.created }}
                    </div>
                    <div>
                        <strong>Size:</strong><br>
                        {{ "%.1f"|format(backup.size / 1024 / 1024) }} MB
                    </div>

                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border-radius: 8px;">
            <h4 style="margin-top: 0;">No backups found</h4>
            <p>Create your first backup to get started with protecting your Finmars installation.</p>
        </div>
    {% endif %}
</div>

<div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007BFF;">
    <h4 style="margin-top: 0; color: #007BFF;">‚ÑπÔ∏è Backup Information</h4>
    <ul style="margin: 10px 0; padding-left: 20px;">
        <li><strong>What's included:</strong> Configuration files (.env, docker-compose.yml), databases, Keycloak data, Nginx configs, and application data</li>
        <li><strong>What's NOT included:</strong> Docker images, logs, and temporary files</li>
        <li><strong>Storage:</strong> Backups are stored in the <code>/backups</code> directory</li>
        <li><strong>Restore process:</strong> Click the "Restore" button to restore a backup. Containers will be stopped during restore and restarted automatically</li>
        <li><strong>Safety:</strong> Always test backups in a non-production environment first</li>
        <li><strong>Data Loss Warning:</strong> Restoring a backup will permanently replace all current data with the backup data</li>
    </ul>
</div>

<style>
    .backups-container {
        max-height: 60vh;
        overflow-y: auto;
    }
    
    .backup-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.2s;
    }
    
    .btn:disabled {
        background-color: #6c757d !important;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .success-message {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .error-message {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .info-message {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .warning-message {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
</style>

<script>
    function showMessage(message, type = 'info') {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = message;
        messageDiv.className = type + '-message';
        messageDiv.style.display = 'block';
        
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    }
    
    document.getElementById('createBackupForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        this.querySelector('button').disabled = true;
        document.body.classList.add('loading');
        showMessage('Creating backup... This may take several minutes.', 'info');
        
        try {
            const response = await fetch('/backup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                showMessage(result.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showMessage(result.message, 'error');
            }
        } catch (error) {
            showMessage('Error creating backup: ' + error.message, 'error');
        } finally {
            this.querySelector('button').disabled = false;
            document.body.classList.remove('loading');
        }
    });
    

    function downloadBackup(timestamp) {
        // Create a temporary link element to trigger download
        const link = document.createElement('a');
        link.href = `/backup/${timestamp}/download`;
        link.download = `backup_${timestamp}.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showMessage('Download started...', 'info');
    }

    async function restoreBackup(date, timestamp) {
        const warningMessage = `‚ö†Ô∏è WARNING: Restoring backup from "${date}" will:\n\n` +
                              `‚Ä¢ Stop all running containers\n` +
                              `‚Ä¢ Replace current database data with backup data\n` +
                              `‚Ä¢ Restart all containers\n\n` +
                              `This action will PERMANENTLY LOSE all current data!\n\n` +
                              `Are you absolutely sure you want to proceed?`;
        
        if (!confirm(warningMessage)) {
            return;
        }
        
        // Double confirmation for safety
        if (!confirm(`FINAL WARNING: This will permanently replace all current data with backup from "${date}".\n\nType "RESTORE" in the next dialog to confirm.`)) {
            return;
        }
        
        const finalConfirmation = prompt(`Type "RESTORE" to confirm data replacement:`);
        if (finalConfirmation !== "RESTORE") {
            showMessage('Restore cancelled. You must type "RESTORE" to confirm.', 'warning');
            return;
        }
        
        showMessage('Starting restore process... This may take several minutes.', 'info');
        
        try {
            const response = await fetch(`/backup/${timestamp}/restore`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showMessage(result.message, 'success');
                // Refresh the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                showMessage(result.message, 'error');
            }
        } catch (error) {
            showMessage('Error restoring backup: ' + error.message, 'error');
        }
    }

    async function deleteBackup(date, timestamp) {
        if (!confirm(`Are you sure you want to delete backup from "${date}"? This action cannot be undone.`)) {
            return;
        }
        
        showMessage('Deleting backup...', 'info');
        
        try {
            const response = await fetch('/backup', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ timestamp: timestamp })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showMessage(result.message, 'success');
                // Refresh the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showMessage(result.message, 'error');
            }
        } catch (error) {
            showMessage('Error deleting backup: ' + error.message, 'error');
        }
    }
</script>
{% endblock %}
